<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Russian Shorts — TikTok Style</title>
<style>
  html, body {
    margin:0; padding:0; height:100%;
    background:#000;
    color:#0f0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
  }
  #feed {
    height: 100vh;
    scroll-snap-type: y mandatory;
    overflow-y: scroll;
  }
  .video-container {
    height: 100vh;
    scroll-snap-align: start;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    background:#111;
  }
  .video-container iframe {
    width: 100vw;
    height: 100vh;
    border: none;
  }
  #loader {
    position: fixed;
    inset:0;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #0f0;
    font-size: 1.5rem;
    z-index: 9999;
  }
</style>
</head>
<body>

<div id="loader">Загрузка...</div>
<div id="feed"></div>

<script>
  const API_KEY = 'AIzaSyDhAKMDqX2G0TNwl3Czk1Dkt89cR2E4e_A'; // Твой ключ
  const feed = document.getElementById('feed');
  const loader = document.getElementById('loader');

  let playerMap = new Map(); // videoId -> YT player
  let videoIds = [];
  let nextPageToken = '';
  let isLoading = false;
  let shownVideos = new Set();

  // Загрузка YouTube Iframe API
  let tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);

  // Функция подгрузки видео
  async function loadVideos() {
    if (isLoading) return;
    isLoading = true;
    try {
      const maxResults = 10;
      const query = '#shorts russian';
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoDuration=short&maxResults=${maxResults}&q=${encodeURIComponent(query)}&relevanceLanguage=ru&regionCode=RU&order=date&pageToken=${nextPageToken}&key=${API_KEY}`;
      let res = await fetch(url);
      let data = await res.json();

      nextPageToken = data.nextPageToken || '';

      for (let item of data.items) {
        let vid = item.id.videoId;
        if (!shownVideos.has(vid)) {
          shownVideos.add(vid);
          videoIds.push(vid);
        }
      }
      renderVideos();
    } catch(e) {
      console.error(e);
      alert('Ошибка загрузки видео');
    } finally {
      isLoading = false;
      loader.style.display = 'none';
    }
  }

  // Рендер видео в feed
  function renderVideos() {
    for (let vid of videoIds) {
      if(document.getElementById('player-' + vid)) continue; // уже есть
      let container = document.createElement('div');
      container.className = 'video-container';
      container.id = 'container-' + vid;
      container.innerHTML = `<div id="player-${vid}"></div>`;
      feed.appendChild(container);
      createPlayer(vid);
    }
  }

  // Создаём YouTube player для видео
  function createPlayer(videoId) {
    playerMap.set(videoId, new YT.Player('player-' + videoId, {
      videoId: videoId,
      playerVars: {
        'autoplay': 0,
        'controls': 0,
        'mute': 0,
        'modestbranding': 1,
        'playsinline': 1,
        'rel': 0,
        'showinfo': 0,
        'loop': 1,
        'playlist': videoId
      },
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    }));
  }

  // При готовности плеера — пока не включаем
  function onPlayerReady(event) {
    // Все видео на паузе и звук выключен
    event.target.pauseVideo();
    event.target.mute();
  }

  // Отслеживаем смену состояния видео
  function onPlayerStateChange(event) {
    // можно добавить если надо
  }

  // Управляем воспроизведением и звуком в зависимости от видимости
  function handleScroll() {
    let containers = document.querySelectorAll('.video-container');
    let viewportHeight = window.innerHeight;

    containers.forEach(container => {
      let rect = container.getBoundingClientRect();
      let videoId = container.id.replace('container-', '');
      let player = playerMap.get(videoId);
      if (!player) return;

      // Если видео почти полностью в зоне видимости (вертикальный центр)
      if(rect.top < viewportHeight/4 && rect.bottom > viewportHeight*3/4){
        player.playVideo();
        player.unMute();
      } else {
        player.pauseVideo();
        player.mute();
      }
    });

    // Если подгрузка почти у конца, грузим ещё
    if(feed.scrollHeight - feed.scrollTop - viewportHeight < viewportHeight*2) {
      loadVideos();
    }
  }

  // Ждём загрузки Iframe API
  function onYouTubeIframeAPIReady() {
    loadVideos();
    feed.addEventListener('scroll', handleScroll);
  }

  // Проброс для YouTube API
  window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

</script>
</body>
</html>
